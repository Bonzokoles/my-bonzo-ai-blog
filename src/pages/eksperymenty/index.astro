---
/**
 * Experiments Page - Bonzo Door Sales Avatar
 * Interactive AI avatar for PORTA door sales
 */
import Layout from "@layouts/Layout.astro";
import PageHeader from "@components/Astro/PageHeader.astro";
import coverImage from "@assets/alk-cover-2.webp";
---

<Layout
  title="Eksperymenty - Bonzo Sprzedawca Drzwi"
  description="Poznaj Bonzo - AI awatara sprzedajƒÖcego drzwi PORTA. Interaktywny asystent z pe≈ÇnƒÖ wiedzƒÖ o modelach, cenach i parametrach technicznych."
>
  <PageHeader
    heading="Bonzo - Tw√≥j Ekspert od Drzwi PORTA"
    description="Interaktywny awatar AI z pe≈ÇnƒÖ wiedzƒÖ o drzwiach PORTA. Zadaj pytanie o modele, ceny, parametry techniczne!"
    image={coverImage}
    imageAlt="Bonzo AI - Ekspert od drzwi PORTA"
    animate={true}
  />

  <section class="container mx-auto px-4 py-12">
    <div class="max-w-4xl mx-auto">
      
      <!-- Google Gemini Avatar Link -->
      <div class="mb-8 p-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-lg text-white">
        <h3 class="text-2xl font-bold mb-2">ü§ñ Google Gemini Avatar (Testowy)</h3>
        <p class="mb-4">Nowa strona z Google Gemini Multimodal - wideo + g≈Ços</p>
        <a 
          href="/avatar" 
          class="inline-block px-6 py-3 bg-white text-blue-600 rounded-lg font-semibold hover:bg-gray-100 transition-colors shadow-lg"
        >
          ‚ñ∂Ô∏è Otw√≥rz Google Avatar
        </a>
      </div>

      <!-- Video Section -->
      <!-- Video Grid: Two videos side by side -->
      <div class="grid md:grid-cols-2 gap-4 mb-8">
        <!-- Static Video -->
        <div
          class="video-container rounded-lg overflow-hidden shadow-lg bg-black flex items-center justify-center relative"
        >
          <video
            id="bonzo-video-1"
            class="h-[600px] w-auto object-contain"
            controls
            autoplay
            muted
            loop
            poster="https://pub-25059caf15274ebd844548094bfb4dc1.r2.dev/alk4.png"
          >
            <source
              src="https://pub-25059caf15274ebd844548094bfb4dc1.r2.dev/DRZWI_DRZWI.mp4"
              type="video/mp4"
            />
            Twoja przeglƒÖdarka nie obs≈Çuguje wideo HTML5.
          </video>
          <p
            class="text-center text-sm text-gray-600 dark:text-gray-400 mt-2 absolute bottom-2"
          >
            Prezentacja Bonzo
          </p>
        </div>

        <!-- Video 2: Bonzo Intro -->
        <div class="video-container">
          <video
            class="w-full h-full object-cover rounded-lg"
            controls
            preload="metadata"
          >
            <source src="/videos/bonzo-intro.mp4" type="video/mp4" />
          </video>
        </div>

        <!-- HeyGen Interactive Avatar (Third Window) -->
        <div
          class="video-container rounded-lg overflow-hidden shadow-lg bg-black flex flex-col items-center justify-center relative"
        >
          <video
            id="heygen-avatar-video"
            class="h-[600px] w-auto object-contain"
            autoplay
            playsInline
          >
          </video>

          <!-- Avatar Controls -->
          <div
            class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-10"
          >
            <button
              id="avatar-connect-btn"
              class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-lg"
            >
              üé• Uruchom Avatara
            </button>
            <button
              id="avatar-disconnect-btn"
              class="hidden px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold shadow-lg"
            >
              üõë Zatrzymaj
            </button>
          </div>

          <!-- Avatar Status -->
          <div
            id="avatar-status"
            class="absolute top-4 left-4 px-3 py-1 bg-gray-900 bg-opacity-80 text-white rounded-lg text-sm"
          >
            ‚ö™ Nieaktywny
          </div>

          <!-- Placeholder when disconnected -->
          <div
            id="avatar-placeholder"
            class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-90"
          >
            <div class="text-center text-white">
              <div
                class="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center"
              >
                <span class="text-5xl">ü§ñ</span>
              </div>
              <p class="text-lg">HeyGen Interactive Avatar</p>
              <p class="text-sm text-gray-400 mt-2">
                Kliknij "Uruchom Avatara" aby rozpoczƒÖƒá
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Interface -->
      <div
        class="chat-container bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-lg"
      >
        <h2 class="text-2xl font-bold mb-4 text-center">Czat z Bonzo</h2>

        <!-- Mode Toggle -->
        <div class="flex justify-center gap-4 mb-6">
          <button
            id="text-mode-btn"
            class="mode-btn active px-6 py-2 rounded-lg font-semibold transition-all duration-200"
          >
            üí¨ Tekst
          </button>
          <button
            id="voice-mode-btn"
            class="mode-btn px-6 py-2 rounded-lg font-semibold transition-all duration-200"
          >
            üé§ G≈Ços (Realtime)
          </button>
        </div>

        <p
          id="mode-description"
          class="text-center mb-6 text-gray-600 dark:text-gray-300"
        >
          Zapytaj o modele PORTA, ceny, parametry techniczne lub porady przy
          wyborze drzwi!
        </p>

        <!-- Voice Interface (hidden by default) -->
        <div id="voice-interface" class="hidden">
          <div class="flex flex-col items-center gap-4 mb-6">
            <button
              id="voice-start-btn"
              class="px-8 py-4 bg-green-600 hover:bg-green-700 text-white rounded-full font-semibold text-lg transition-all duration-200 flex items-center gap-2"
            >
              <span class="text-2xl">üé§</span>
              <span>Rozpocznij Rozmowƒô</span>
            </button>
            <button
              id="voice-stop-btn"
              class="hidden px-8 py-4 bg-red-600 hover:bg-red-700 text-white rounded-full font-semibold text-lg transition-all duration-200 flex items-center gap-2"
            >
              <span class="text-2xl">üõë</span>
              <span>Zako≈Ñcz Rozmowƒô</span>
            </button>
            <div
              id="voice-status"
              class="text-sm text-gray-500 dark:text-gray-400"
            >
              Naci≈õnij przycisk aby rozpoczƒÖƒá rozmowƒô g≈ÇosowƒÖ
            </div>
          </div>
        </div>

        <!-- Text Interface (shown by default) -->
        <div id="text-interface">
          <div
            id="chat-messages"
            class="chat-messages bg-white dark:bg-gray-900 rounded-lg p-4 mb-4 h-96 overflow-y-auto"
          >
            <div class="message bot-message mb-4">
              <div class="font-bold text-blue-600 dark:text-blue-400 mb-1">
                Bonzo:
              </div>
              <div class="text-gray-800 dark:text-gray-200">
                Cze≈õƒá! Jestem Bonzo, Tw√≥j ekspert od drzwi PORTA. Pomogƒô Ci
                wybraƒá idealne drzwi! Mamy 5 ≈õwietnych modeli - od stylowych
                FOCUS PREMIUM (od 1033 PLN) po eleganckie VERTE HOME. Zadaj
                pytanie o ceny, parametry lub pomoc w wyborze!
              </div>
            </div>
          </div>

          <div class="chat-input flex gap-2">
            <input
              type="text"
              id="user-input"
              placeholder="Zapytaj o drzwi PORTA..."
              class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
            />
            <button
              id="send-btn"
              class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors duration-200"
            >
              Wy≈õlij
            </button>
          </div>

          <div
            class="mt-4 text-sm text-gray-500 dark:text-gray-400 text-center"
          >
            üí° Przyk≈Çady: "Jakie masz modele?", "Ile kosztuje FOCUS PREMIUM?",
            "Kt√≥re drzwi majƒÖ szk≈Ço?"
          </div>
        </div>
      </div>

      <!-- Knowledge Base -->
      <div class="mt-12 grid md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4">üìã Dostƒôpne Modele</h3>
          <ul class="space-y-2 text-sm">
            <li>‚úÖ PORTA FOCUS PREMIUM 5.A - od 1033 PLN</li>
            <li>‚úÖ PORTA FACTOR 5 - od 629 PLN</li>
            <li>‚úÖ PORTA DESIRE 5</li>
            <li>‚úÖ PORTA ART DECO 5</li>
            <li>‚úÖ PORTA VERTE HOME H.5</li>
          </ul>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4">üìû Kontakt</h3>
          <div class="text-sm space-y-2">
            <p><strong>Sprzedawca:</strong> Norbert</p>
            <p><strong>Telefon:</strong> 790 645 410</p>
            <p><strong>Dostƒôpno≈õƒá:</strong> po 23:00 w ≈õrodƒô</p>
            <p class="text-xs text-gray-500 mt-4">
              Mo≈ºesz te≈º kontaktowaƒá siƒô mailowo dla szczeg√≥≈Ç√≥w
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Video container positioning */
  .video-container {
    position: relative;
    min-height: 600px;
  }

  .chat-messages {
    scrollbar-width: thin;
  }

  .message {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .bot-message {
    background: #e3f2fd;
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 4px solid #2196f3;
  }

  .user-message {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 4px solid #4caf50;
  }

  .dark .bot-message {
    background: #1e3a5f;
    border-left-color: #64b5f6;
  }

  .dark .user-message {
    background: #2d2d2d;
    border-left-color: #81c784;
  }

  /* Mode Toggle Styles */
  .mode-btn {
    border: 2px solid #e0e0e0;
    background: white;
    color: #666;
  }

  .mode-btn.active {
    background: #2196f3;
    border-color: #2196f3;
    color: white;
  }

  .dark .mode-btn {
    background: #2d2d2d;
    border-color: #444;
    color: #ccc;
  }

  .dark .mode-btn.active {
    background: #1976d2;
    border-color: #1976d2;
    color: white;
  }

  /* Voice Animation */
  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.8;
    }
  }

  .voice-active {
    animation: pulse 2s infinite;
  }
</style>

<script>
  // UI Elements
  const chatMessages = document.getElementById("chat-messages");
  const userInput = document.getElementById("user-input") as HTMLInputElement;
  const sendBtn = document.getElementById("send-btn");
  const textModeBtn = document.getElementById("text-mode-btn");
  const voiceModeBtn = document.getElementById("voice-mode-btn");
  const textInterface = document.getElementById("text-interface");
  const voiceInterface = document.getElementById("voice-interface");
  const voiceStartBtn = document.getElementById("voice-start-btn");
  const voiceStopBtn = document.getElementById("voice-stop-btn");
  const voiceStatus = document.getElementById("voice-status");
  const modeDescription = document.getElementById("mode-description");

  // Voice state
  let voiceSession: WebSocket | null = null;
  let audioContext: AudioContext | null = null;
  let mediaStream: MediaStream | null = null;
  let isVoiceActive = false;

  // Mode Toggle
  textModeBtn?.addEventListener("click", () => {
    textModeBtn.classList.add("active");
    voiceModeBtn?.classList.remove("active");
    textInterface?.classList.remove("hidden");
    voiceInterface?.classList.add("hidden");
    if (modeDescription)
      modeDescription.textContent =
        "Zapytaj o modele PORTA, ceny, parametry techniczne lub porady przy wyborze drzwi!";
    stopVoiceSession();
  });

  voiceModeBtn?.addEventListener("click", () => {
    voiceModeBtn.classList.add("active");
    textModeBtn?.classList.remove("active");
    voiceInterface?.classList.remove("hidden");
    textInterface?.classList.add("hidden");
    if (modeDescription)
      modeDescription.textContent =
        "Kliknij przycisk i rozmawiaj z Bonzo g≈Çosowo! AI odpowie Ci w czasie rzeczywistym.";
  });

  // Voice Session Management
  voiceStartBtn?.addEventListener("click", startVoiceSession);
  voiceStopBtn?.addEventListener("click", stopVoiceSession);

  async function startVoiceSession() {
    try {
      updateVoiceStatus("≈ÅƒÖczenie z Bonzo...");

      // Get session token
      const response = await fetch("/api/ai/bonzo-voice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!response.ok) throw new Error("Failed to create session");

      const { client_secret } = await response.json();

      // Request microphone access
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

      // Initialize audio context
      audioContext = new (window.AudioContext ||
        (window as any).webkitAudioContext)();

      // Connect to WebSocket
      const wsUrl = `wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17`;
      voiceSession = new WebSocket(wsUrl, [], {
        headers: {
          Authorization: `Bearer ${client_secret}`,
          "OpenAI-Beta": "realtime=v1",
        },
      } as any);

      voiceSession.onopen = () => {
        updateVoiceStatus("‚úÖ Po≈ÇƒÖczono! M√≥w do mikrofonu...");
        voiceStartBtn?.classList.add("hidden");
        voiceStopBtn?.classList.remove("hidden");
        voiceStartBtn?.classList.add("voice-active");
        isVoiceActive = true;

        // Start audio capture
        startAudioCapture();
      };

      voiceSession.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleRealtimeEvent(data);
      };

      voiceSession.onerror = (error) => {
        console.error("WebSocket error:", error);
        updateVoiceStatus("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia");
        stopVoiceSession();
      };

      voiceSession.onclose = () => {
        updateVoiceStatus("Roz≈ÇƒÖczono");
        stopVoiceSession();
      };
    } catch (error) {
      console.error("Voice session error:", error);
      updateVoiceStatus("‚ùå Nie uda≈Ço siƒô uruchomiƒá rozmowy");
      stopVoiceSession();
    }
  }

  function stopVoiceSession() {
    isVoiceActive = false;

    if (voiceSession) {
      voiceSession.close();
      voiceSession = null;
    }

    if (mediaStream) {
      mediaStream.getTracks().forEach((track) => track.stop());
      mediaStream = null;
    }

    if (audioContext) {
      audioContext.close();
      audioContext = null;
    }

    voiceStartBtn?.classList.remove("hidden", "voice-active");
    voiceStopBtn?.classList.add("hidden");
    updateVoiceStatus("Naci≈õnij przycisk aby rozpoczƒÖƒá rozmowƒô g≈ÇosowƒÖ");
  }

  function updateVoiceStatus(message: string) {
    if (voiceStatus) voiceStatus.textContent = message;
  }

  function startAudioCapture() {
    if (!mediaStream || !audioContext || !voiceSession) return;

    const source = audioContext.createMediaStreamSource(mediaStream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    source.connect(processor);
    processor.connect(audioContext.destination);

    processor.onaudioprocess = (e) => {
      if (
        !isVoiceActive ||
        !voiceSession ||
        voiceSession.readyState !== WebSocket.OPEN
      )
        return;

      const inputData = e.inputBuffer.getChannelData(0);
      const pcm16 = convertFloat32ToPCM16(inputData);
      const base64Audio = arrayBufferToBase64(pcm16);

      voiceSession.send(
        JSON.stringify({
          type: "input_audio_buffer.append",
          audio: base64Audio,
        }),
      );
    };
  }

  function handleRealtimeEvent(event: any) {
    console.log("Realtime event:", event.type);

    switch (event.type) {
      case "response.audio.delta":
        playAudioDelta(event.delta);
        break;
      case "response.audio_transcript.delta":
        updateVoiceStatus(`üîä Bonzo: ${event.delta}`);
        break;
      case "response.done":
        updateVoiceStatus("‚úÖ Bonzo sko≈Ñczy≈Ç m√≥wiƒá. Twoja kolej!");
        break;
      case "input_audio_buffer.speech_started":
        updateVoiceStatus("üé§ S≈Çucham...");
        break;
      case "input_audio_buffer.speech_stopped":
        updateVoiceStatus("‚è≥ Przetwarzanie...");
        break;
      case "error":
        console.error("Realtime error:", event.error);
        updateVoiceStatus(`‚ùå B≈ÇƒÖd: ${event.error.message}`);
        break;
    }
  }

  function playAudioDelta(base64Audio: string) {
    if (!audioContext) return;

    const audioData = base64ToArrayBuffer(base64Audio);
    audioContext.decodeAudioData(audioData, (buffer) => {
      const source = audioContext!.createBufferSource();
      source.buffer = buffer;
      source.connect(audioContext!.destination);
      source.start();
    });
  }

  // Utility functions
  function convertFloat32ToPCM16(float32Array: Float32Array): ArrayBuffer {
    const pcm16 = new Int16Array(float32Array.length);
    for (let i = 0; i < float32Array.length; i++) {
      const s = Math.max(-1, Math.min(1, float32Array[i]));
      pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
    }
    return pcm16.buffer;
  }

  function arrayBufferToBase64(buffer: ArrayBuffer): string {
    const bytes = new Uint8Array(buffer);
    let binary = "";
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  function base64ToArrayBuffer(base64: string): ArrayBuffer {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }

  // Text Chat functionality
  async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    addMessage("user", message);
    userInput.value = "";

    const typingId = addMessage("bot", "Bonzo pisze...");

    try {
      // Use Gemini AI instead of OpenAI
      const response = await fetch("/api/ai/gemini-chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message }),
      });

      const data = (await response.json()) as {
        reply?: string;
        error?: string;
        audioUrl?: string;
      };
      document.getElementById(typingId)?.remove();

      if (!response.ok || data.error) {
        addMessage(
          "bot",
          `Przepraszam, wystƒÖpi≈Ç problem: ${data.error || "Nieznany b≈ÇƒÖd"}. Sprawd≈∫ CF_ACCOUNT_ID w Cloudflare Pages.`,
        );
        console.error("API error:", data.error, "Status:", response.status);
        return;
      }

      addMessage("bot", data.reply || "Brak odpowiedzi");

      // Play HeyGen audio if available
      if (data.audioUrl) {
        const audio = new Audio(data.audioUrl);
        audio
          .play()
          .catch((err) => console.error("Audio playback error:", err));
      }
    } catch (error) {
      document.getElementById(typingId)?.remove();
      addMessage(
        "bot",
        "Przepraszam, wystƒÖpi≈Ç problem z po≈ÇƒÖczeniem. Spr√≥buj ponownie za chwilƒô.",
      );
      console.error("Chat error:", error);
    }
  }

  function addMessage(type: "user" | "bot", text: string): string {
    const messageId = `msg-${Date.now()}`;
    const messageDiv = document.createElement("div");
    messageDiv.id = messageId;
    messageDiv.className = `message ${type}-message mb-4`;

    const senderName = type === "bot" ? "Bonzo" : "Ty";
    const senderColor =
      type === "bot"
        ? "text-blue-600 dark:text-blue-400"
        : "text-green-600 dark:text-green-400";

    messageDiv.innerHTML = `
      <div class="font-bold ${senderColor} mb-1">${senderName}:</div>
      <div class="text-gray-800 dark:text-gray-200">${text}</div>
    `;

    chatMessages?.appendChild(messageDiv);
    chatMessages?.scrollTo(0, chatMessages.scrollHeight);

    return messageId;
  }

  sendBtn?.addEventListener("click", sendMessage);
  userInput?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  // ============================================
  // HeyGen Interactive Avatar Integration
  // ============================================

  let avatarSessionId: string | null = null;
  let peerConnection: RTCPeerConnection | null = null;

  const avatarVideo = document.getElementById(
    "heygen-avatar-video",
  ) as HTMLVideoElement;
  const connectBtn = document.getElementById("avatar-connect-btn");
  const disconnectBtn = document.getElementById("avatar-disconnect-btn");
  const avatarStatus = document.getElementById("avatar-status");
  const avatarPlaceholder = document.getElementById("avatar-placeholder");

  async function connectAvatar() {
    try {
      avatarStatus!.textContent = "üîÑ ≈ÅƒÖczenie...";
      avatarStatus!.className =
        "absolute top-4 left-4 px-3 py-1 bg-yellow-600 bg-opacity-80 text-white rounded-lg text-sm";

      // Create HeyGen session
      const response = await fetch("/api/ai/avatar-stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "create" }),
      });

      if (!response.ok) throw new Error("Failed to create session");

      const data = (await response.json()) as {
        session_id: string;
        sdp: { type: string; sdp: string };
        ice_servers: any[];
      };

      console.log("HeyGen CREATE data:", data);
      avatarSessionId = data.session_id;

      // Setup WebRTC
      peerConnection = new RTCPeerConnection({
        iceServers: data.ice_servers || [
          { urls: "stun:stun.l.google.com:19302" },
        ],
      });

      peerConnection.ontrack = (event) => {
        console.log("WebRTC ontrack:", event);
        if (avatarVideo && event.streams[0]) {
          avatarVideo.srcObject = event.streams[0];
          avatarPlaceholder!.style.display = "none";
        }
      };

      peerConnection.oniceconnectionstatechange = () => {
        console.log("ICE state:", peerConnection!.iceConnectionState);
        if (peerConnection!.iceConnectionState === "connected") {
          avatarStatus!.textContent = "üü¢ Po≈ÇƒÖczony";
          avatarStatus!.className =
            "absolute top-4 left-4 px-3 py-1 bg-green-600 bg-opacity-80 text-white rounded-lg text-sm";
        }
      };

      // Set remote description (HeyGen's SDP offer)
      console.log("Setting remote SDP:", data.sdp);
      await peerConnection.setRemoteDescription(
        new RTCSessionDescription({
          type: data.sdp.type as RTCSdpType,
          sdp: data.sdp.sdp,
        }),
      );

      // Create and set local description (our answer)
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      // Send local SDP back to HeyGen via START endpoint
      const startResponse = await fetch("/api/ai/avatar-stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "start",
          sessionId: avatarSessionId,
          sdp: answer.sdp,
        }),
      });

      if (!startResponse.ok) {
        throw new Error("Failed to start ICE exchange");
      }

      connectBtn!.classList.add("hidden");
      disconnectBtn!.classList.remove("hidden");
    } catch (error) {
      console.error("Failed to connect avatar:", error);
      avatarStatus!.textContent = "üî¥ B≈ÇƒÖd po≈ÇƒÖczenia";
      avatarStatus!.className =
        "absolute top-4 left-4 px-3 py-1 bg-red-600 bg-opacity-80 text-white rounded-lg text-sm";
      alert(
        "Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z avatarem. Sprawd≈∫ konfiguracjƒô HEYGEN_API_KEY.",
      );
    }
  }

  async function disconnectAvatar() {
    if (avatarSessionId) {
      try {
        await fetch("/api/ai/avatar-stream", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "close", sessionId: avatarSessionId }),
        });
      } catch (error) {
        console.error("Failed to close session:", error);
      }
    }

    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }

    if (avatarVideo) {
      avatarVideo.srcObject = null;
    }

    avatarPlaceholder!.style.display = "flex";
    avatarSessionId = null;

    avatarStatus!.textContent = "‚ö™ Nieaktywny";
    avatarStatus!.className =
      "absolute top-4 left-4 px-3 py-1 bg-gray-900 bg-opacity-80 text-white rounded-lg text-sm";

    connectBtn!.classList.remove("hidden");
    disconnectBtn!.classList.add("hidden");
  }

  // Wrapper for sendMessage to also send to avatar when connected
  const originalSendMessage = sendMessage;
  async function sendMessageWithAvatar() {
    await originalSendMessage();

    // If avatar is connected, send last bot message to avatar
    if (avatarSessionId && chatMessages) {
      const botMessages = chatMessages.querySelectorAll(".bot-message");
      const lastBotMessage = botMessages[botMessages.length - 1];

      if (lastBotMessage) {
        const text =
          lastBotMessage.textContent?.replace("Bonzo:", "").trim() || "";

        try {
          await fetch("/api/ai/avatar-stream", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "talk",
              sessionId: avatarSessionId,
              message: text,
            }),
          });
        } catch (error) {
          console.error("Failed to send to avatar:", error);
        }
      }
    }
  }

  // Replace original sendMessage
  sendBtn?.removeEventListener("click", sendMessage);
  sendBtn?.addEventListener("click", sendMessageWithAvatar);

  userInput?.removeEventListener("keypress", (e: any) => {
    if (e.key === "Enter") sendMessage();
  });
  userInput?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessageWithAvatar();
  });

  connectBtn?.addEventListener("click", connectAvatar);
  disconnectBtn?.addEventListener("click", disconnectAvatar);
</script>
