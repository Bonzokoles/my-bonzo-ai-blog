---
/**
 * Experiments Page - Bonzo Door Sales Avatar
 * Interactive AI avatar for PORTA door sales
 */
import Layout from "@layouts/Layout.astro";
import PageHeader from "@components/Astro/PageHeader.astro";
import coverImage from "@assets/alk-cover-2.webp";
---

<Layout
  title="Eksperymenty - Bonzo Sprzedawca Drzwi"
  description="Poznaj Bonzo - AI awatara sprzedajƒÖcego drzwi PORTA. Interaktywny asystent z pe≈ÇnƒÖ wiedzƒÖ o modelach, cenach i parametrach technicznych."
>
  <PageHeader
    heading="Bonzo - Tw√≥j Ekspert od Drzwi PORTA"
    description="Interaktywny awatar AI z pe≈ÇnƒÖ wiedzƒÖ o drzwiach PORTA. Zadaj pytanie o modele, ceny, parametry techniczne!"
    image={coverImage}
    imageAlt="Bonzo AI - Ekspert od drzwi PORTA"
    animate={true}
  />

  <section class="container mx-auto px-4 py-12">
    <div class="max-w-4xl mx-auto">
      <!-- Interactive Avatar Video -->
      <div class="mb-8">
        <div class="video-container rounded-lg overflow-hidden shadow-lg bg-gray-900 relative">
          <video
            id="avatar-video"
            class="w-full aspect-video"
            autoplay
            playsinline
          ></video>
          <div id="avatar-status" class="absolute top-4 left-4 bg-black bg-opacity-70 text-white px-4 py-2 rounded-lg">
            ≈Åadowanie awatara...
          </div>
        </div>
        <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-2">
          üé≠ Interaktywny Awatar Bonzo - Rozmawia na ≈ºywo!
        </p>
      </div>

      <!-- Chat Interface -->
      <div
        class="chat-container bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-lg"
      >
        <h2 class="text-2xl font-bold mb-4 text-center">Czat z Bonzo</h2>

        <p class="text-center mb-6 text-gray-600 dark:text-gray-300">
          Zapytaj o modele PORTA, ceny, parametry techniczne lub porady przy wyborze drzwi!
          Bonzo odpowie g≈Çosem przez interaktywnego awatara powy≈ºej üëÜ
        </p>

        <div id="text-interface">
          <div
            id="chat-messages"
            class="chat-messages bg-white dark:bg-gray-900 rounded-lg p-4 mb-4 h-96 overflow-y-auto"
          >
            <div class="message bot-message mb-4">
              <div class="font-bold text-blue-600 dark:text-blue-400 mb-1">
                Bonzo:
              </div>
              <div class="text-gray-800 dark:text-gray-200">
                Cze≈õƒá! Jestem Bonzo, Tw√≥j ekspert od drzwi PORTA. Pomogƒô Ci
                wybraƒá idealne drzwi! Mamy 5 ≈õwietnych modeli - od stylowych
                FOCUS PREMIUM (od 1033 PLN) po eleganckie VERTE HOME. Zadaj
                pytanie o ceny, parametry lub pomoc w wyborze!
              </div>
            </div>
          </div>

          <div class="chat-input flex gap-2">
            <input
              type="text"
              id="user-input"
              placeholder="Zapytaj o drzwi PORTA..."
              class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
            />
            <button
              id="send-btn"
              class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors duration-200"
            >
              Wy≈õlij
            </button>
          </div>

          <div
            class="mt-4 text-sm text-gray-500 dark:text-gray-400 text-center"
          >
            üí° Przyk≈Çady: "Jakie masz modele?", "Ile kosztuje FOCUS PREMIUM?",
            "Kt√≥re drzwi majƒÖ szk≈Ço?"
          </div>
        </div>
      </div>

      <!-- Knowledge Base -->
      <div class="mt-12 grid md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4">üìã Dostƒôpne Modele</h3>
          <ul class="space-y-2 text-sm">
            <li>‚úÖ PORTA FOCUS PREMIUM 5.A - od 1033 PLN</li>
            <li>‚úÖ PORTA FACTOR 5 - od 629 PLN</li>
            <li>‚úÖ PORTA DESIRE 5</li>
            <li>‚úÖ PORTA ART DECO 5</li>
            <li>‚úÖ PORTA VERTE HOME H.5</li>
          </ul>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4">üìû Kontakt</h3>
          <div class="text-sm space-y-2">
            <p><strong>Sprzedawca:</strong> Norbert</p>
            <p><strong>Telefon:</strong> 790 645 410</p>
            <p><strong>Dostƒôpno≈õƒá:</strong> po 23:00 w ≈õrodƒô</p>
            <p class="text-xs text-gray-500 mt-4">
              Mo≈ºesz te≈º kontaktowaƒá siƒô mailowo dla szczeg√≥≈Ç√≥w
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  .chat-messages {
    scrollbar-width: thin;
  }

  .message {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .bot-message {
    background: #e3f2fd;
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 4px solid #2196f3;
  }

  .user-message {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 4px solid #4caf50;
  }

  .dark .bot-message {
    background: #1e3a5f;
    border-left-color: #64b5f6;
  }

  .dark .user-message {
    background: #2d2d2d;
    border-left-color: #81c784;
  }

  /* Mode Toggle Styles */
  .mode-btn {
    border: 2px solid #e0e0e0;
    background: white;
    color: #666;
  }

  .mode-btn.active {
    background: #2196f3;
    border-color: #2196f3;
    color: white;
  }

  .dark .mode-btn {
    background: #2d2d2d;
    border-color: #444;
    color: #ccc;
  }

  .dark .mode-btn.active {
    background: #1976d2;
    border-color: #1976d2;
    color: white;
  }

  /* Voice Animation */
  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.8;
    }
  }

  .voice-active {
    animation: pulse 2s infinite;
  }
</style>

<script>
  // UI Elements
  const chatMessages = document.getElementById("chat-messages");
  const userInput = document.getElementById("user-input") as HTMLInputElement;
  const sendBtn = document.getElementById("send-btn");
  const avatarVideo = document.getElementById("avatar-video") as HTMLVideoElement;
  const avatarStatus = document.getElementById("avatar-status");

  // Avatar state
  let avatarSessionId: string | null = null;
  let peerConnection: RTCPeerConnection | null = null;
  let isAvatarReady = false;

  // Initialize avatar on page load
  window.addEventListener('DOMContentLoaded', initializeAvatar);

  async function startVoiceSession() {
    try {
      updateVoiceStatus("≈ÅƒÖczenie z Bonzo...");

      // Get session token
      const response = await fetch("/api/ai/bonzo-voice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!response.ok) throw new Error("Failed to create session");

      const { client_secret } = await response.json();

      // Request microphone access
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

      // Initialize audio context
      audioContext = new (window.AudioContext ||
        (window as any).webkitAudioContext)();

      // Connect to WebSocket with ephemeral token in protocol
      const wsUrl = `wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17`;
      voiceSession = new WebSocket(wsUrl, [
        'realtime',
        `openai-insecure-api-key.${client_secret}`,
        'openai-beta.realtime-v1'
      ]);

      voiceSession.onopen = () => {
        updateVoiceStatus("‚úÖ Po≈ÇƒÖczono! M√≥w do mikrofonu...");
        voiceStartBtn?.classList.add("hidden");
        voiceStopBtn?.classList.remove("hidden");
        voiceStartBtn?.classList.add("voice-active");
        isVoiceActive = true;

        // Start audio capture
        startAudioCapture();
      };

      voiceSession.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleRealtimeEvent(data);
      };

      voiceSession.onerror = (error) => {
        console.error("WebSocket error:", error);
        updateVoiceStatus("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia");
        stopVoiceSession();
      };

      voiceSession.onclose = () => {
        updateVoiceStatus("Roz≈ÇƒÖczono");
        stopVoiceSession();
      };
    } catch (error) {
      console.error("Voice session error:", error);
      updateVoiceStatus("‚ùå Nie uda≈Ço siƒô uruchomiƒá rozmowy");
      stopVoiceSession();
    }
  }

  function stopVoiceSession() {
    isVoiceActive = false;

    if (voiceSession) {
      voiceSession.close();
      voiceSession = null;
    }

    if (mediaStream) {
      mediaStream.getTracks().forEach((track) => track.stop());
      mediaStream = null;
    }

    if (audioContext) {
      audioContext.close();
      audioContext = null;
    }

    voiceStartBtn?.classList.remove("hidden", "voice-active");
    voiceStopBtn?.classList.add("hidden");
    updateVoiceStatus("Naci≈õnij przycisk aby rozpoczƒÖƒá rozmowƒô g≈ÇosowƒÖ");
  }

  function updateVoiceStatus(message: string) {
    if (voiceStatus) voiceStatus.textContent = message;
  }

  function startAudioCapture() {
    if (!mediaStream || !audioContext || !voiceSession) return;

    const source = audioContext.createMediaStreamSource(mediaStream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    source.connect(processor);
    processor.connect(audioContext.destination);

    processor.onaudioprocess = (e) => {
      if (
        !isVoiceActive ||
        !voiceSession ||
        voiceSession.readyState !== WebSocket.OPEN
      )
        return;

      const inputData = e.inputBuffer.getChannelData(0);
      const pcm16 = convertFloat32ToPCM16(inputData);
      const base64Audio = arrayBufferToBase64(pcm16);

      voiceSession.send(
        JSON.stringify({
          type: "input_audio_buffer.append",
          audio: base64Audio,
        }),
      );
    };
  }

  function handleRealtimeEvent(event: any) {
    console.log("Realtime event:", event.type);

    switch (event.type) {
      case "response.audio.delta":
        playAudioDelta(event.delta);
        break;
      case "response.audio_transcript.delta":
        updateVoiceStatus(`üîä Bonzo: ${event.delta}`);
        break;
      case "response.done":
        updateVoiceStatus("‚úÖ Bonzo sko≈Ñczy≈Ç m√≥wiƒá. Twoja kolej!");
        break;
      case "input_audio_buffer.speech_started":
        updateVoiceStatus("üé§ S≈Çucham...");
        break;
      case "input_audio_buffer.speech_stopped":
        updateVoiceStatus("‚è≥ Przetwarzanie...");
        break;
      case "error":
        console.error("Realtime error:", event.error);
        updateVoiceStatus(`‚ùå B≈ÇƒÖd: ${event.error.message}`);
        break;
    }
  }

  function playAudioDelta(base64Audio: string) {
    if (!audioContext) return;

    // Decode base64 to PCM16 data
    const pcm16Data = base64ToArrayBuffer(base64Audio);
    const int16Array = new Int16Array(pcm16Data);

    // Convert PCM16 to Float32 for Web Audio API
    const float32Array = new Float32Array(int16Array.length);
    for (let i = 0; i < int16Array.length; i++) {
      float32Array[i] = int16Array[i] / (int16Array[i] < 0 ? 0x8000 : 0x7fff);
    }

    // Create audio buffer (24kHz mono from OpenAI)
    const audioBuffer = audioContext.createBuffer(1, float32Array.length, 24000);
    audioBuffer.getChannelData(0).set(float32Array);

    // Play the audio
    const source = audioContext.createBufferSource();
    source.buffer = audioBuffer;
    source.connect(audioContext.destination);
    source.start();
  }

  // Utility functions
  function convertFloat32ToPCM16(float32Array: Float32Array): ArrayBuffer {
    const pcm16 = new Int16Array(float32Array.length);
    for (let i = 0; i < float32Array.length; i++) {
      const s = Math.max(-1, Math.min(1, float32Array[i]));
      pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
    }
    return pcm16.buffer;
  }

  function arrayBufferToBase64(buffer: ArrayBuffer): string {
    const bytes = new Uint8Array(buffer);
    let binary = "";
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  function base64ToArrayBuffer(base64: string): ArrayBuffer {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }

  // Text Chat functionality
  async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    addMessage("user", message);
    userInput.value = "";

    const typingId = addMessage("bot", "Bonzo pisze...");

    try {
      const response = await fetch("/api/ai/bonzo-chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message }),
      });

      if (!response.ok) throw new Error("API error");

      const data = await response.json();
      document.getElementById(typingId)?.remove();
      addMessage("bot", data.reply);

      // Play HeyGen audio if available
      if (data.audioUrl) {
        const audio = new Audio(data.audioUrl);
        audio
          .play()
          .catch((err) => console.error("Audio playback error:", err));
      }
    } catch (error) {
      document.getElementById(typingId)?.remove();
      addMessage(
        "bot",
        "Przepraszam, wystƒÖpi≈Ç problem. Spr√≥buj ponownie za chwilƒô.",
      );
      console.error("Chat error:", error);
    }
  }

  function addMessage(type: "user" | "bot", text: string): string {
    const messageId = `msg-${Date.now()}`;
    const messageDiv = document.createElement("div");
    messageDiv.id = messageId;
    messageDiv.className = `message ${type}-message mb-4`;

    const senderName = type === "bot" ? "Bonzo" : "Ty";
    const senderColor =
      type === "bot"
        ? "text-blue-600 dark:text-blue-400"
        : "text-green-600 dark:text-green-400";

    messageDiv.innerHTML = `
      <div class="font-bold ${senderColor} mb-1">${senderName}:</div>
      <div class="text-gray-800 dark:text-gray-200">${text}</div>
    `;

    chatMessages?.appendChild(messageDiv);
    chatMessages?.scrollTo(0, chatMessages.scrollHeight);

    return messageId;
  }

  sendBtn?.addEventListener("click", sendMessage);
  userInput?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
  });
</script>
